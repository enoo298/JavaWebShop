<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>Your Shopping Cart</title>
  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet" crossorigin="anonymous"/>
  <meta name="_csrf"       th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container mt-5">
  <h2>Your Shopping Cart</h2>

  <div th:if="${#lists.isEmpty(items)}" class="alert alert-info">
    Your cart is empty.
  </div>

  <div th:unless="${#lists.isEmpty(items)}">
    <table class="table table-dark table-striped">
      <thead>
      <tr>
        <th>Product</th>
        <th>Price</th>
        <th>Qty</th>
        <th>Subtotal</th>
        <th>Action</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="item : ${items}"
          th:attr="data-item-id=${item.id}">
        <td th:text="${item.product.name}">Name</td>
        <td class="price" th:text="${item.product.price}">0.00</td>
        <td>
          <input type="number"
                 class="form-control quantity"
                 style="width:4em;"
                 min="1"
                 th:value="${item.quantity}"/>
        </td>
        <td class="subtotal"
            th:text="${item.product.price * item.quantity}">
          0.00
        </td>
        <td>
          <button class="btn btn-danger btn-sm remove-btn">
            Remove
          </button>
        </td>
      </tr>
      </tbody>
      <tfoot>
      <tr>
        <td colspan="3" class="text-end"><strong>Total:</strong></td>
        <td id="cart-total" th:text="${total}">0.00</td>
        <td></td>
      </tr>
      </tfoot>
    </table>

    <div class="d-flex justify-content-between">
      <button id="clear-cart-btn" class="btn btn-outline-danger">
        Clear Cart
      </button>
      <div>
        <a th:href="@{/products/listProducts}" class="btn btn-secondary">
          Continue Shopping
        </a>
        <a th:href="@{/checkout}" class="btn btn-success">
          Checkout
        </a>
      </div>
    </div>
  </div>
</div>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous" defer></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
    const csrfToken  = document.querySelector('meta[name="_csrf"]').content;

    function recalcTotal() {
      let sum = 0;
      document.querySelectorAll('.subtotal').forEach(td => {
        sum += parseFloat(td.textContent);
      });
      document.getElementById('cart-total').textContent = sum.toFixed(2);
    }

    // Quantity change
    document.querySelectorAll('.quantity').forEach(input => {
      input.addEventListener('change', () => {
        const tr     = input.closest('tr');
        const itemId = tr.dataset.itemId;
        const qty    = input.value;
        fetch(`/cart/update/${itemId}?quantity=${qty}`, {
          method: 'POST',
          headers: { [csrfHeader]: csrfToken }
        })
                .then(r => r.json())
                .then(() => {
                  const price = parseFloat(tr.querySelector('.price').textContent);
                  tr.querySelector('.subtotal').textContent = (price * qty).toFixed(2);
                  recalcTotal();
                })
                .catch(console.error);
      });
    });

    // Remove item
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr     = btn.closest('tr');
        const itemId = tr.dataset.itemId;
        fetch(`/cart/remove/${itemId}`, {
          method: 'POST',
          headers: { [csrfHeader]: csrfToken }
        })
                .then(r => r.json())
                .then(() => {
                  tr.remove();
                  recalcTotal();
                })
                .catch(console.error);
      });
    });

    // Clear cart
    document.getElementById('clear-cart-btn')
            .addEventListener('click', () => {
              fetch('/cart/clear', {
                method: 'POST',
                headers: { [csrfHeader]: csrfToken }
              })
                      .then(r => r.json())
                      .then(() => {
                        document.querySelectorAll('tbody tr').forEach(r => r.remove());
                        document.getElementById('cart-total').textContent = '0.00';
                      })
                      .catch(console.error);
            });
  });
</script>
</body>
</html>
