<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Products</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
            crossorigin="anonymous"/>
    <!-- CSRF za AJAX -->
    <meta name="_csrf"       th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

<!-- Tvoj navbar fragment -->
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container mt-5">
    <h2>Products</h2>
    <div class="row">
        <div class="col-md-4 mb-4"
             th:each="prod : ${products}">
            <div class="card h-100">
                <img th:src="@{${prod.imagePath}}"
                     class="card-img-top" alt="â€¦"/>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title" th:text="${prod.name}">Name</h5>
                    <p class="card-text" th:text="${prod.description}">Desc</p>
                    <div class="mt-auto">
                        <p><strong th:text="${prod.price}">0.00</strong></p>
                        <button class="btn btn-primary add-cart-btn"
                                th:data-id="${prod.id}">
                            Add to Cart
                        </button>
                        <a th:href="@{/products/{id}(id=${prod.id})}"
                           class="btn btn-outline-light">Details</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous" defer></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
        const csrfToken  = document.querySelector('meta[name="_csrf"]').content;

        document.querySelectorAll('.add-cart-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const prodId = btn.dataset.id;
                fetch(`/cart/add/${prodId}?quantity=1`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                    .then(res => res.json())
                    .then(() => {
                        // odmah idi u cart
                        window.location.href = '/cart';
                    })
                    .catch(console.error);
            });
        });
    });
</script>
</body>
</html>
